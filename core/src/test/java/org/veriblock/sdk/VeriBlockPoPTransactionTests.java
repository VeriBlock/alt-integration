// VeriBlock Blockchain Project
// Copyright 2017-2018 VeriBlock, Inc
// Copyright 2018-2019 Xenios SEZC
// All rights reserved.
// https://www.veriblock.org
// Distributed under the MIT software license, see the accompanying
// file LICENSE or http://www.opensource.org/licenses/mit-license.php.

package org.veriblock.sdk;

import org.junit.Assert;
import org.junit.Test;
import org.veriblock.sdk.services.SerializeDeserializeService;
import org.veriblock.sdk.services.ValidationService;
import org.veriblock.sdk.util.Utils;

import java.nio.ByteBuffer;
import java.util.Arrays;
import java.util.Base64;

public class VeriBlockPoPTransactionTests {
    @Test
    public void verify_WhenValid() {
        VeriBlockPoPTransaction tx = new VeriBlockPoPTransaction(
                new Address("VE6MJFzmGdYdrxC8o6UCovVv7BdhdX"),
                SerializeDeserializeService.parseVeriBlockBlock(Base64.getDecoder().decode("AAATNQACp5PIctb2Rg6QvtYjQruWgZX4xRXT7tcnegnvrEvpn5XwoVYosGujtEwBkLXASVybis0HAcUjXru+nA==")),
                new BitcoinTransaction(Base64.getDecoder().decode("AQAAAAEM508ftpSgAe67HX0IzmIIAz9b9yY+utLeB7v1GGcnMgAAAABqRzBEAiAM9JmKuhaCq+t3fnYoB6ndJjWgt3dz9mSRuD7jyHCZugIgM7fKJNxSCRW4sCAMvc+VumroZjVFha+cU+6G8nNi6+wBIQPluvBwnDlagu8L1jvIhHVkrCAdaajmv0SNh6pTocQxqv////8CtycNAAAAAAAZdqkUi56oVFBZ86kiRXr9FN3zhV2LEJmIrAAAAAAAAAAAU2pMUAAAEzUAAqeTyHLW9kYOkL7WI0K7loGV+MUV0+7XJ3oJ76xL6Z+V8KFWKLBro7RMAZC1wElcm4rNBwHFI167vpzU6UPv4YZN8EIWYVz5IIP0AAAAAA==")),
                new MerklePath("1659:94E097B110BA3ADBB7B6C4C599D31D675DE7BE6E722407410C08EF352BE585F1:4D66077FDF24246FFD6B6979DFEDEF5D46588654ADDEB35EDB11E993C131F612:023D1ABE8758C6F917EC0C65674BBD43D66EE14DC667B3117DFC44690C6F5AF1:096DDBA03CA952AF133FB06307C24171E53BF50AB76F1EDEABDE5E99F78D4EAD:2F32CF1BEE50349D56FC1943AF84F2D2ABDA520F64DC4DB37B2F3DB20B0ECB57:93E70120F1B539D0C1495B368061129F30D35F9E436F32D69967AE86031A2756:F554378A116E2142F9F6315A38B19BD8A1B2E6DC31201F2D37A058F03C39C06C:0824705685CECA003C95140434EE9D8BBBF4474B83FD4ECC2766137DB9A44D74:B7B9E52F3EE8CE4FBB8BE7D6CF66D33A20293F806C69385136662A74453FB162:1732C9A35E80D4796BABEA76AACE50B49F6079EA3E349F026B4491CFE720AD17:2D9B57E92AB51FE28A587050FD82ABB30ABD699A5CE8B54E7CD49B2A827BCB99:DCBA229ACDC6B7F028BA756FD5ABBFEBD31B4227CD4137D728EC5EA56C457618:2CF1439A6DBCC1A35E96574BDDBF2C5DB9174AF5AD0D278FE92E06E4AC349A42"),
                SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AADAIBNPCdQ2WetTmC2a+0RLlvpLtYwDfSkUAAAAAAAAAAAAzgsamnfdDbEntd9Lw2jNasKZqXR9mR7C2svAtpmi5KWzkZtcbB8sF3NwO8A=")),
                Arrays.asList(
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AACAIPxhzJ1OrEstFHYaTQavip7wc9zX+14NAAAAAAAAAAAAoxUI1LEB0K0R5D75QZwj/Cd/Z+2ug8WY7nCGbbzvXiUmi5tcbB8sF+EYdK8=")),
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AABAID+OOYAwRDnYU8MC9uSWKF4RDiUSUVMTAAAAAAAAAAAAOacsIiaDgb2Nnc/gAvRyY0okzwRU3otQ+J4QiR5f+x3gjZtcbB8sF0QpCpI=")),
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AAAAILqkLkA0Wn+CajHTfbGl1ktntycyR3QiAAAAAAAAAAAAozrWvgY0ZHsmYzq4X6jeJYSAu7JeWcaOSLsLYIsSNisQkZtcbB8sF0nE0fA="))),
                Base64.getDecoder().decode("MEUCIQD03ORe3Ma/xKH0TvBOR+kKNI79Rx90Lxi4gqx3qNDongIgYXz3xKIiEZkWh7FxJsG7AHo7KiXFUPddZrhXqP2ddec="),
                Base64.getDecoder().decode("MFYwEAYHKoZIzj0CAQYFK4EEAAoDQgAEs8EEcMjo5Cbxk3dY2ftel6GJEXbLN9TBLUr0EHsao+iop1TAaiJ2DkTGBkL7qIOWfBl0DVIxM2Mm95YnUMjfmQ=="), null);

        try {
            ValidationService.verify(tx);
            Assert.assertEquals(Sha256Hash.wrap("2A014E88ED7AB65CDFAA85DAEAB07EEA6CBA5E147F736EDD8D02C2F9DDF0DEC6"), SerializeDeserializeService.getId(tx));
        } catch (Exception e) {
            Assert.fail();
        }
    }

    @Test
    public void checkSignature_WhenPublicKeyFromDifferentAddress() {
        VeriBlockPoPTransaction tx = new VeriBlockPoPTransaction(
                new Address("VE6MJFzmGdYdrxC8o6UCovVv7BdhdX"),
                SerializeDeserializeService.parseVeriBlockBlock(Base64.getDecoder().decode("AAATNQACp5PIctb2Rg6QvtYjQruWgZX4xRXT7tcnegnvrEvpn5XwoVYosGujtEwBkLXASVybis0HAcUjXru+nA==")),
                new BitcoinTransaction(Base64.getDecoder().decode("AQAAAAEM508ftpSgAe67HX0IzmIIAz9b9yY+utLeB7v1GGcnMgAAAABqRzBEAiAM9JmKuhaCq+t3fnYoB6ndJjWgt3dz9mSRuD7jyHCZugIgM7fKJNxSCRW4sCAMvc+VumroZjVFha+cU+6G8nNi6+wBIQPluvBwnDlagu8L1jvIhHVkrCAdaajmv0SNh6pTocQxqv////8CtycNAAAAAAAZdqkUi56oVFBZ86kiRXr9FN3zhV2LEJmIrAAAAAAAAAAAU2pMUAAAEzUAAqeTyHLW9kYOkL7WI0K7loGV+MUV0+7XJ3oJ76xL6Z+V8KFWKLBro7RMAZC1wElcm4rNBwHFI167vpzU6UPv4YZN8EIWYVz5IIP0AAAAAA==")),
                new MerklePath("1659:94E097B110BA3ADBB7B6C4C599D31D675DE7BE6E722407410C08EF352BE585F1:4D66077FDF24246FFD6B6979DFEDEF5D46588654ADDEB35EDB11E993C131F612:023D1ABE8758C6F917EC0C65674BBD43D66EE14DC667B3117DFC44690C6F5AF1:096DDBA03CA952AF133FB06307C24171E53BF50AB76F1EDEABDE5E99F78D4EAD:2F32CF1BEE50349D56FC1943AF84F2D2ABDA520F64DC4DB37B2F3DB20B0ECB57:93E70120F1B539D0C1495B368061129F30D35F9E436F32D69967AE86031A2756:F554378A116E2142F9F6315A38B19BD8A1B2E6DC31201F2D37A058F03C39C06C:0824705685CECA003C95140434EE9D8BBBF4474B83FD4ECC2766137DB9A44D74:B7B9E52F3EE8CE4FBB8BE7D6CF66D33A20293F806C69385136662A74453FB162:1732C9A35E80D4796BABEA76AACE50B49F6079EA3E349F026B4491CFE720AD17:2D9B57E92AB51FE28A587050FD82ABB30ABD699A5CE8B54E7CD49B2A827BCB99:DCBA229ACDC6B7F028BA756FD5ABBFEBD31B4227CD4137D728EC5EA56C457618:2CF1439A6DBCC1A35E96574BDDBF2C5DB9174AF5AD0D278FE92E06E4AC349A42"),
                SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AADAIBNPCdQ2WetTmC2a+0RLlvpLtYwDfSkUAAAAAAAAAAAAzgsamnfdDbEntd9Lw2jNasKZqXR9mR7C2svAtpmi5KWzkZtcbB8sF3NwO8A=")),
                Arrays.asList(
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AACAIPxhzJ1OrEstFHYaTQavip7wc9zX+14NAAAAAAAAAAAAoxUI1LEB0K0R5D75QZwj/Cd/Z+2ug8WY7nCGbbzvXiUmi5tcbB8sF+EYdK8=")),
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AABAID+OOYAwRDnYU8MC9uSWKF4RDiUSUVMTAAAAAAAAAAAAOacsIiaDgb2Nnc/gAvRyY0okzwRU3otQ+J4QiR5f+x3gjZtcbB8sF0QpCpI=")),
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AAAAILqkLkA0Wn+CajHTfbGl1ktntycyR3QiAAAAAAAAAAAAozrWvgY0ZHsmYzq4X6jeJYSAu7JeWcaOSLsLYIsSNisQkZtcbB8sF0nE0fA="))),
                Base64.getDecoder().decode("MEUCIQD03ORe3Ma/xKH0TvBOR+kKNI79Rx90Lxi4gqx3qNDongIgYXz3xKIiEZkWh7FxJsG7AHo7KiXFUPddZrhXqP2ddec="),
                Base64.getDecoder().decode("MFYwEAYHKoZIzj0CAQYFK4EEAAoDQgAEtVgobuGeWdi00PclBbYkkdI5rTqvZlfVKrXCoJyT7DYeETWbJSepJKeRNar5xh65FQ009A6JKZ7VTdU3LrssiA=="), null);

        try {
            ValidationService.checkSignature(tx);
            Assert.fail();
        } catch (VerificationException e) {
            Assert.assertTrue("VeriBlock PoP Transaction contains an invalid public key".equals(e.getMessage()));
        }
    }

    @Test
    public void checkSignature_WhenSignatureInvalid() {
        VeriBlockPoPTransaction tx = new VeriBlockPoPTransaction(
                new Address("VE6MJFzmGdYdrxC8o6UCovVv7BdhdX"),
                SerializeDeserializeService.parseVeriBlockBlock(Base64.getDecoder().decode("AAATNQACp5PIctb2Rg6QvtYjQruWgZX4xRXT7tcnegnvrEvpn5XwoVYosGujtEwBkLXASVybis0HAcUjXru+nA==")),
                new BitcoinTransaction(Base64.getDecoder().decode("AQAAAAEM508ftpSgAe67HX0IzmIIAz9b9yY+utLeB7v1GGcnMgAAAABqRzBEAiAM9JmKuhaCq+t3fnYoB6ndJjWgt3dz9mSRuD7jyHCZugIgM7fKJNxSCRW4sCAMvc+VumroZjVFha+cU+6G8nNi6+wBIQPluvBwnDlagu8L1jvIhHVkrCAdaajmv0SNh6pTocQxqv////8CtycNAAAAAAAZdqkUi56oVFBZ86kiRXr9FN3zhV2LEJmIrAAAAAAAAAAAU2pMUAAAEzUAAqeTyHLW9kYOkL7WI0K7loGV+MUV0+7XJ3oJ76xL6Z+V8KFWKLBro7RMAZC1wElcm4rNBwHFI167vpzU6UPv4YZN8EIWYVz5IIP0AAAAAA==")),
                new MerklePath("1659:94E097B110BA3ADBB7B6C4C599D31D675DE7BE6E722407410C08EF352BE585F1:4D66077FDF24246FFD6B6979DFEDEF5D46588654ADDEB35EDB11E993C131F612:023D1ABE8758C6F917EC0C65674BBD43D66EE14DC667B3117DFC44690C6F5AF1:096DDBA03CA952AF133FB06307C24171E53BF50AB76F1EDEABDE5E99F78D4EAD:2F32CF1BEE50349D56FC1943AF84F2D2ABDA520F64DC4DB37B2F3DB20B0ECB57:93E70120F1B539D0C1495B368061129F30D35F9E436F32D69967AE86031A2756:F554378A116E2142F9F6315A38B19BD8A1B2E6DC31201F2D37A058F03C39C06C:0824705685CECA003C95140434EE9D8BBBF4474B83FD4ECC2766137DB9A44D74:B7B9E52F3EE8CE4FBB8BE7D6CF66D33A20293F806C69385136662A74453FB162:1732C9A35E80D4796BABEA76AACE50B49F6079EA3E349F026B4491CFE720AD17:2D9B57E92AB51FE28A587050FD82ABB30ABD699A5CE8B54E7CD49B2A827BCB99:DCBA229ACDC6B7F028BA756FD5ABBFEBD31B4227CD4137D728EC5EA56C457618:2CF1439A6DBCC1A35E96574BDDBF2C5DB9174AF5AD0D278FE92E06E4AC349A42"),
                SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AADAIBNPCdQ2WetTmC2a+0RLlvpLtYwDfSkUAAAAAAAAAAAAzgsamnfdDbEntd9Lw2jNasKZqXR9mR7C2svAtpmi5KWzkZtcbB8sF3NwO8A=")),
                Arrays.asList(
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AACAIPxhzJ1OrEstFHYaTQavip7wc9zX+14NAAAAAAAAAAAAoxUI1LEB0K0R5D75QZwj/Cd/Z+2ug8WY7nCGbbzvXiUmi5tcbB8sF+EYdK8=")),
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AABAID+OOYAwRDnYU8MC9uSWKF4RDiUSUVMTAAAAAAAAAAAAOacsIiaDgb2Nnc/gAvRyY0okzwRU3otQ+J4QiR5f+x3gjZtcbB8sF0QpCpI=")),
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AAAAILqkLkA0Wn+CajHTfbGl1ktntycyR3QiAAAAAAAAAAAAozrWvgY0ZHsmYzq4X6jeJYSAu7JeWcaOSLsLYIsSNisQkZtcbB8sF0nE0fA="))),
                Utils.decodeHex("30450220034DC73796E9870E6679F47E48F3AC794327FD19D9023C228CD134D8ED87B796022100AD0CE8A520AAE704447920CA365D57A881A82A7455293A9C10E622E0BDD732AF"),
                Base64.getDecoder().decode("MFYwEAYHKoZIzj0CAQYFK4EEAAoDQgAEs8EEcMjo5Cbxk3dY2ftel6GJEXbLN9TBLUr0EHsao+iop1TAaiJ2DkTGBkL7qIOWfBl0DVIxM2Mm95YnUMjfmQ=="), null);

        try {
            ValidationService.checkSignature(tx);
            Assert.fail();
        } catch (VerificationException e) {
            Assert.assertTrue("VeriBlock PoP Transaction is incorrectly signed".equals(e.getMessage()));
        }
    }

    @Test
    public void checkBitcoinTransactionForPoPData_WhenPoPDataNotInBitcoinTransaction() {
        VeriBlockPoPTransaction tx = new VeriBlockPoPTransaction(
                new Address("VE6MJFzmGdYdrxC8o6UCovVv7BdhdX"),
                SerializeDeserializeService.parseVeriBlockBlock(Base64.getDecoder().decode("AAATiAAClOfcPjviGpbszw+99fYqMzHcmVw2sJNWN4YGed3V2w8TUxKywnhnyag+8bmbmFyblJMHAjrWcrr9dw==")),
                new BitcoinTransaction(Base64.getDecoder().decode("AQAAAAEM508ftpSgAe67HX0IzmIIAz9b9yY+utLeB7v1GGcnMgAAAABqRzBEAiAM9JmKuhaCq+t3fnYoB6ndJjWgt3dz9mSRuD7jyHCZugIgM7fKJNxSCRW4sCAMvc+VumroZjVFha+cU+6G8nNi6+wBIQPluvBwnDlagu8L1jvIhHVkrCAdaajmv0SNh6pTocQxqv////8CtycNAAAAAAAZdqkUi56oVFBZ86kiRXr9FN3zhV2LEJmIrAAAAAAAAAAAU2pMUAAAEzUAAqeTyHLW9kYOkL7WI0K7loGV+MUV0+7XJ3oJ76xL6Z+V8KFWKLBro7RMAZC1wElcm4rNBwHFI167vpzU6UPv4YZN8EIWYVz5IIP0AAAAAA==")),
                new MerklePath("1659:94E097B110BA3ADBB7B6C4C599D31D675DE7BE6E722407410C08EF352BE585F1:4D66077FDF24246FFD6B6979DFEDEF5D46588654ADDEB35EDB11E993C131F612:023D1ABE8758C6F917EC0C65674BBD43D66EE14DC667B3117DFC44690C6F5AF1:096DDBA03CA952AF133FB06307C24171E53BF50AB76F1EDEABDE5E99F78D4EAD:2F32CF1BEE50349D56FC1943AF84F2D2ABDA520F64DC4DB37B2F3DB20B0ECB57:93E70120F1B539D0C1495B368061129F30D35F9E436F32D69967AE86031A2756:F554378A116E2142F9F6315A38B19BD8A1B2E6DC31201F2D37A058F03C39C06C:0824705685CECA003C95140434EE9D8BBBF4474B83FD4ECC2766137DB9A44D74:B7B9E52F3EE8CE4FBB8BE7D6CF66D33A20293F806C69385136662A74453FB162:1732C9A35E80D4796BABEA76AACE50B49F6079EA3E349F026B4491CFE720AD17:2D9B57E92AB51FE28A587050FD82ABB30ABD699A5CE8B54E7CD49B2A827BCB99:DCBA229ACDC6B7F028BA756FD5ABBFEBD31B4227CD4137D728EC5EA56C457618:2CF1439A6DBCC1A35E96574BDDBF2C5DB9174AF5AD0D278FE92E06E4AC349A42"),
                SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AADAIBNPCdQ2WetTmC2a+0RLlvpLtYwDfSkUAAAAAAAAAAAAzgsamnfdDbEntd9Lw2jNasKZqXR9mR7C2svAtpmi5KWzkZtcbB8sF3NwO8A=")),
                Arrays.asList(
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AACAIPxhzJ1OrEstFHYaTQavip7wc9zX+14NAAAAAAAAAAAAoxUI1LEB0K0R5D75QZwj/Cd/Z+2ug8WY7nCGbbzvXiUmi5tcbB8sF+EYdK8=")),
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AABAID+OOYAwRDnYU8MC9uSWKF4RDiUSUVMTAAAAAAAAAAAAOacsIiaDgb2Nnc/gAvRyY0okzwRU3otQ+J4QiR5f+x3gjZtcbB8sF0QpCpI=")),
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AAAAILqkLkA0Wn+CajHTfbGl1ktntycyR3QiAAAAAAAAAAAAozrWvgY0ZHsmYzq4X6jeJYSAu7JeWcaOSLsLYIsSNisQkZtcbB8sF0nE0fA="))),
                Base64.getDecoder().decode("MEUCIQD03ORe3Ma/xKH0TvBOR+kKNI79Rx90Lxi4gqx3qNDongIgYXz3xKIiEZkWh7FxJsG7AHo7KiXFUPddZrhXqP2ddec="),
                Base64.getDecoder().decode("MFYwEAYHKoZIzj0CAQYFK4EEAAoDQgAEs8EEcMjo5Cbxk3dY2ftel6GJEXbLN9TBLUr0EHsao+iop1TAaiJ2DkTGBkL7qIOWfBl0DVIxM2Mm95YnUMjfmQ=="), null);

        try {
            ValidationService.checkBitcoinTransactionForPoPData(tx);
            Assert.fail();
        } catch (VerificationException e) {
            Assert.assertTrue("Bitcoin transaction does not contain PoP publication data".equals(e.getMessage()));
        }
    }

    @Test
    public void checkBitcoinMerklePath_WhenMerklePathProvesADifferentTransaction() {
        VeriBlockPoPTransaction tx = new VeriBlockPoPTransaction(
                new Address("VE6MJFzmGdYdrxC8o6UCovVv7BdhdX"),
                SerializeDeserializeService.parseVeriBlockBlock(Base64.getDecoder().decode("AAATNQACp5PIctb2Rg6QvtYjQruWgZX4xRXT7tcnegnvrEvpn5XwoVYosGujtEwBkLXASVybis0HAcUjXru+nA==")),
                new BitcoinTransaction(Base64.getDecoder().decode("AQAAAAEM508ftpSgAe67HX0IzmIIAz9b9yY+utLeB7v1GGcnMgAAAABqRzBEAiAM9JmKuhaCq+t3fnYoB6ndJjWgt3dz9mSRuD7jyHCZugIgM7fKJNxSCRW4sCAMvc+VumroZjVFha+cU+6G8nNi6+wBIQPluvBwnDlagu8L1jvIhHVkrCAdaajmv0SNh6pTocQxqv////8CtycNAAAAAAAZdqkUi56oVFBZ86kiRXr9FN3zhV2LEJmIrAAAAAAAAAAAU2pMUAAAEzUAAqeTyHLW9kYOkL7WI0K7loGV+MUV0+7XJ3oJ76xL6Z+V8KFWKLBro7RMAZC1wElcm4rNBwHFI167vpzU6UPv4YZN8EIWYVz5IIP0AAAAAA==")),
                new MerklePath("1659:012A4E88ED7AB65CDFAA85DAEAB07EEA6CBA5E147F736EDD8D02C2F9DDF0DEC6:4D66077FDF24246FFD6B6979DFEDEF5D46588654ADDEB35EDB11E993C131F612:023D1ABE8758C6F917EC0C65674BBD43D66EE14DC667B3117DFC44690C6F5AF1:096DDBA03CA952AF133FB06307C24171E53BF50AB76F1EDEABDE5E99F78D4EAD:2F32CF1BEE50349D56FC1943AF84F2D2ABDA520F64DC4DB37B2F3DB20B0ECB57:93E70120F1B539D0C1495B368061129F30D35F9E436F32D69967AE86031A2756:F554378A116E2142F9F6315A38B19BD8A1B2E6DC31201F2D37A058F03C39C06C:0824705685CECA003C95140434EE9D8BBBF4474B83FD4ECC2766137DB9A44D74:B7B9E52F3EE8CE4FBB8BE7D6CF66D33A20293F806C69385136662A74453FB162:1732C9A35E80D4796BABEA76AACE50B49F6079EA3E349F026B4491CFE720AD17:2D9B57E92AB51FE28A587050FD82ABB30ABD699A5CE8B54E7CD49B2A827BCB99:DCBA229ACDC6B7F028BA756FD5ABBFEBD31B4227CD4137D728EC5EA56C457618:2CF1439A6DBCC1A35E96574BDDBF2C5DB9174AF5AD0D278FE92E06E4AC349A42"),
                SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AADAIBNPCdQ2WetTmC2a+0RLlvpLtYwDfSkUAAAAAAAAAAAAzgsamnfdDbEntd9Lw2jNasKZqXR9mR7C2svAtpmi5KWzkZtcbB8sF3NwO8A=")),
                Arrays.asList(
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AACAIPxhzJ1OrEstFHYaTQavip7wc9zX+14NAAAAAAAAAAAAoxUI1LEB0K0R5D75QZwj/Cd/Z+2ug8WY7nCGbbzvXiUmi5tcbB8sF+EYdK8=")),
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AABAID+OOYAwRDnYU8MC9uSWKF4RDiUSUVMTAAAAAAAAAAAAOacsIiaDgb2Nnc/gAvRyY0okzwRU3otQ+J4QiR5f+x3gjZtcbB8sF0QpCpI=")),
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AAAAILqkLkA0Wn+CajHTfbGl1ktntycyR3QiAAAAAAAAAAAAozrWvgY0ZHsmYzq4X6jeJYSAu7JeWcaOSLsLYIsSNisQkZtcbB8sF0nE0fA="))),
                Base64.getDecoder().decode("MEUCIQD03ORe3Ma/xKH0TvBOR+kKNI79Rx90Lxi4gqx3qNDongIgYXz3xKIiEZkWh7FxJsG7AHo7KiXFUPddZrhXqP2ddec="),
                Base64.getDecoder().decode("MFYwEAYHKoZIzj0CAQYFK4EEAAoDQgAEs8EEcMjo5Cbxk3dY2ftel6GJEXbLN9TBLUr0EHsao+iop1TAaiJ2DkTGBkL7qIOWfBl0DVIxM2Mm95YnUMjfmQ=="), null);

        try {
            ValidationService.checkBitcoinMerklePath(tx);
            Assert.fail();
        } catch (VerificationException e) {
            Assert.assertTrue("Bitcoin transaction cannot be proven by merkle path".equals(e.getMessage()));
        }
    }

    @Test
    public void checkBitcoinMerklePath_WhenMerkleRootsDoNotMatch() {
        VeriBlockPoPTransaction tx = new VeriBlockPoPTransaction(
                new Address("VE6MJFzmGdYdrxC8o6UCovVv7BdhdX"),
                SerializeDeserializeService.parseVeriBlockBlock(Base64.getDecoder().decode("AAATNQACp5PIctb2Rg6QvtYjQruWgZX4xRXT7tcnegnvrEvpn5XwoVYosGujtEwBkLXASVybis0HAcUjXru+nA==")),
                new BitcoinTransaction(Base64.getDecoder().decode("AQAAAAEM508ftpSgAe67HX0IzmIIAz9b9yY+utLeB7v1GGcnMgAAAABqRzBEAiAM9JmKuhaCq+t3fnYoB6ndJjWgt3dz9mSRuD7jyHCZugIgM7fKJNxSCRW4sCAMvc+VumroZjVFha+cU+6G8nNi6+wBIQPluvBwnDlagu8L1jvIhHVkrCAdaajmv0SNh6pTocQxqv////8CtycNAAAAAAAZdqkUi56oVFBZ86kiRXr9FN3zhV2LEJmIrAAAAAAAAAAAU2pMUAAAEzUAAqeTyHLW9kYOkL7WI0K7loGV+MUV0+7XJ3oJ76xL6Z+V8KFWKLBro7RMAZC1wElcm4rNBwHFI167vpzU6UPv4YZN8EIWYVz5IIP0AAAAAA==")),
                new MerklePath("1659:94E097B110BA3ADBB7B6C4C599D31D675DE7BE6E722407410C08EF352BE585F1:4D66077FDF24246FFD6B6979DFEDEF5D46588654ADDEB35EDB11E993C131F612:023D1ABE8758C6F917EC0C65674BBD43D66EE14DC667B3117DFC44690C6F5AF1:096DDBA03CA952AF133FB06307C24171E53BF50AB76F1EDEABDE5E99F78D4EAD:2F32CF1BEE50349D56FC1943AF84F2D2ABDA520F64DC4DB37B2F3DB20B0ECB57:93E70120F1B539D0C1495B368061129F30D35F9E436F32D69967AE86031A2756:F554378A116E2142F9F6315A38B19BD8A1B2E6DC31201F2D37A058F03C39C06C:0824705685CECA003C95140434EE9D8BBBF4474B83FD4ECC2766137DB9A44D74:B7B9E52F3EE8CE4FBB8BE7D6CF66D33A20293F806C69385136662A74453FB162:1732C9A35E80D4796BABEA76AACE50B49F6079EA3E349F026B4491CFE720AD17:2D9B57E92AB51FE28A587050FD82ABB30ABD699A5CE8B54E7CD49B2A827BCB99:DCBA229ACDC6B7F028BA756FD5ABBFEBD31B4227CD4137D728EC5EA56C457618:2CF1439A6DBCC1A35E96574BDDBF2C5DB9174AF5AD0D278FE92E06E4AC349A42"),
                SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AAAAILqkLkA0Wn+CajHTfbGl1ktntycyR3QiAAAAAAAAAAAAozrWvgY0ZHsmYzq4X6jeJYSAu7JeWcaOSLsLYIsSNisQkZtcbB8sF0nE0fA=")),
                Arrays.asList(
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AACAIPxhzJ1OrEstFHYaTQavip7wc9zX+14NAAAAAAAAAAAAoxUI1LEB0K0R5D75QZwj/Cd/Z+2ug8WY7nCGbbzvXiUmi5tcbB8sF+EYdK8=")),
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AABAID+OOYAwRDnYU8MC9uSWKF4RDiUSUVMTAAAAAAAAAAAAOacsIiaDgb2Nnc/gAvRyY0okzwRU3otQ+J4QiR5f+x3gjZtcbB8sF0QpCpI="))),
                Base64.getDecoder().decode("MEUCIQD03ORe3Ma/xKH0TvBOR+kKNI79Rx90Lxi4gqx3qNDongIgYXz3xKIiEZkWh7FxJsG7AHo7KiXFUPddZrhXqP2ddec="),
                Base64.getDecoder().decode("MFYwEAYHKoZIzj0CAQYFK4EEAAoDQgAEs8EEcMjo5Cbxk3dY2ftel6GJEXbLN9TBLUr0EHsao+iop1TAaiJ2DkTGBkL7qIOWfBl0DVIxM2Mm95YnUMjfmQ=="), null);

        try {
            ValidationService.checkBitcoinMerklePath(tx);
            Assert.fail();
        } catch (VerificationException e) {
            Assert.assertTrue("Bitcoin transaction does not belong to block of proof".equals(e.getMessage()));
        }
    }

    @Test
    public void checkBitcoinBlocks_WhenNotContiguous() {
        VeriBlockPoPTransaction tx = new VeriBlockPoPTransaction(
                new Address("VE6MJFzmGdYdrxC8o6UCovVv7BdhdX"),
                SerializeDeserializeService.parseVeriBlockBlock(Base64.getDecoder().decode("AAATNQACp5PIctb2Rg6QvtYjQruWgZX4xRXT7tcnegnvrEvpn5XwoVYosGujtEwBkLXASVybis0HAcUjXru+nA==")),
                new BitcoinTransaction(Base64.getDecoder().decode("AQAAAAEM508ftpSgAe67HX0IzmIIAz9b9yY+utLeB7v1GGcnMgAAAABqRzBEAiAM9JmKuhaCq+t3fnYoB6ndJjWgt3dz9mSRuD7jyHCZugIgM7fKJNxSCRW4sCAMvc+VumroZjVFha+cU+6G8nNi6+wBIQPluvBwnDlagu8L1jvIhHVkrCAdaajmv0SNh6pTocQxqv////8CtycNAAAAAAAZdqkUi56oVFBZ86kiRXr9FN3zhV2LEJmIrAAAAAAAAAAAU2pMUAAAEzUAAqeTyHLW9kYOkL7WI0K7loGV+MUV0+7XJ3oJ76xL6Z+V8KFWKLBro7RMAZC1wElcm4rNBwHFI167vpzU6UPv4YZN8EIWYVz5IIP0AAAAAA==")),
                new MerklePath("1659:94E097B110BA3ADBB7B6C4C599D31D675DE7BE6E722407410C08EF352BE585F1:4D66077FDF24246FFD6B6979DFEDEF5D46588654ADDEB35EDB11E993C131F612:023D1ABE8758C6F917EC0C65674BBD43D66EE14DC667B3117DFC44690C6F5AF1:096DDBA03CA952AF133FB06307C24171E53BF50AB76F1EDEABDE5E99F78D4EAD:2F32CF1BEE50349D56FC1943AF84F2D2ABDA520F64DC4DB37B2F3DB20B0ECB57:93E70120F1B539D0C1495B368061129F30D35F9E436F32D69967AE86031A2756:F554378A116E2142F9F6315A38B19BD8A1B2E6DC31201F2D37A058F03C39C06C:0824705685CECA003C95140434EE9D8BBBF4474B83FD4ECC2766137DB9A44D74:B7B9E52F3EE8CE4FBB8BE7D6CF66D33A20293F806C69385136662A74453FB162:1732C9A35E80D4796BABEA76AACE50B49F6079EA3E349F026B4491CFE720AD17:2D9B57E92AB51FE28A587050FD82ABB30ABD699A5CE8B54E7CD49B2A827BCB99:DCBA229ACDC6B7F028BA756FD5ABBFEBD31B4227CD4137D728EC5EA56C457618:2CF1439A6DBCC1A35E96574BDDBF2C5DB9174AF5AD0D278FE92E06E4AC349A42"),
                SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AADAIBNPCdQ2WetTmC2a+0RLlvpLtYwDfSkUAAAAAAAAAAAAzgsamnfdDbEntd9Lw2jNasKZqXR9mR7C2svAtpmi5KWzkZtcbB8sF3NwO8A=")),
                Arrays.asList(
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AACAIPxhzJ1OrEstFHYaTQavip7wc9zX+14NAAAAAAAAAAAAoxUI1LEB0K0R5D75QZwj/Cd/Z+2ug8WY7nCGbbzvXiUmi5tcbB8sF+EYdK8=")),
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AAAAILqkLkA0Wn+CajHTfbGl1ktntycyR3QiAAAAAAAAAAAAozrWvgY0ZHsmYzq4X6jeJYSAu7JeWcaOSLsLYIsSNisQkZtcbB8sF0nE0fA="))),
                Base64.getDecoder().decode("MEUCIQD03ORe3Ma/xKH0TvBOR+kKNI79Rx90Lxi4gqx3qNDongIgYXz3xKIiEZkWh7FxJsG7AHo7KiXFUPddZrhXqP2ddec="),
                Base64.getDecoder().decode("MFYwEAYHKoZIzj0CAQYFK4EEAAoDQgAEs8EEcMjo5Cbxk3dY2ftel6GJEXbLN9TBLUr0EHsao+iop1TAaiJ2DkTGBkL7qIOWfBl0DVIxM2Mm95YnUMjfmQ=="), null);

        try {
            ValidationService.checkBitcoinBlocks(tx);
            Assert.fail();
        } catch (VerificationException e) {
            Assert.assertTrue("Blocks are not contiguous".equals(e.getMessage()));
        }
    }

    @Test
    public void parse() {
        VeriBlockPoPTransaction input = new VeriBlockPoPTransaction(
                new Address("VE6MJFzmGdYdrxC8o6UCovVv7BdhdX"),
                SerializeDeserializeService.parseVeriBlockBlock(Base64.getDecoder().decode("AAATNQACp5PIctb2Rg6QvtYjQruWgZX4xRXT7tcnegnvrEvpn5XwoVYosGujtEwBkLXASVybis0HAcUjXru+nA==")),
                new BitcoinTransaction(Base64.getDecoder().decode("AQAAAAEM508ftpSgAe67HX0IzmIIAz9b9yY+utLeB7v1GGcnMgAAAABqRzBEAiAM9JmKuhaCq+t3fnYoB6ndJjWgt3dz9mSRuD7jyHCZugIgM7fKJNxSCRW4sCAMvc+VumroZjVFha+cU+6G8nNi6+wBIQPluvBwnDlagu8L1jvIhHVkrCAdaajmv0SNh6pTocQxqv////8CtycNAAAAAAAZdqkUi56oVFBZ86kiRXr9FN3zhV2LEJmIrAAAAAAAAAAAU2pMUAAAEzUAAqeTyHLW9kYOkL7WI0K7loGV+MUV0+7XJ3oJ76xL6Z+V8KFWKLBro7RMAZC1wElcm4rNBwHFI167vpzU6UPv4YZN8EIWYVz5IIP0AAAAAA==")),
                new MerklePath("1659:94E097B110BA3ADBB7B6C4C599D31D675DE7BE6E722407410C08EF352BE585F1:4D66077FDF24246FFD6B6979DFEDEF5D46588654ADDEB35EDB11E993C131F612:023D1ABE8758C6F917EC0C65674BBD43D66EE14DC667B3117DFC44690C6F5AF1:096DDBA03CA952AF133FB06307C24171E53BF50AB76F1EDEABDE5E99F78D4EAD:2F32CF1BEE50349D56FC1943AF84F2D2ABDA520F64DC4DB37B2F3DB20B0ECB57:93E70120F1B539D0C1495B368061129F30D35F9E436F32D69967AE86031A2756:F554378A116E2142F9F6315A38B19BD8A1B2E6DC31201F2D37A058F03C39C06C:0824705685CECA003C95140434EE9D8BBBF4474B83FD4ECC2766137DB9A44D74:B7B9E52F3EE8CE4FBB8BE7D6CF66D33A20293F806C69385136662A74453FB162:1732C9A35E80D4796BABEA76AACE50B49F6079EA3E349F026B4491CFE720AD17:2D9B57E92AB51FE28A587050FD82ABB30ABD699A5CE8B54E7CD49B2A827BCB99:DCBA229ACDC6B7F028BA756FD5ABBFEBD31B4227CD4137D728EC5EA56C457618:2CF1439A6DBCC1A35E96574BDDBF2C5DB9174AF5AD0D278FE92E06E4AC349A42"),
                SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AADAIBNPCdQ2WetTmC2a+0RLlvpLtYwDfSkUAAAAAAAAAAAAzgsamnfdDbEntd9Lw2jNasKZqXR9mR7C2svAtpmi5KWzkZtcbB8sF3NwO8A=")),
                Arrays.asList(
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AACAIPxhzJ1OrEstFHYaTQavip7wc9zX+14NAAAAAAAAAAAAoxUI1LEB0K0R5D75QZwj/Cd/Z+2ug8WY7nCGbbzvXiUmi5tcbB8sF+EYdK8=")),
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AABAID+OOYAwRDnYU8MC9uSWKF4RDiUSUVMTAAAAAAAAAAAAOacsIiaDgb2Nnc/gAvRyY0okzwRU3otQ+J4QiR5f+x3gjZtcbB8sF0QpCpI=")),
                        SerializeDeserializeService.parseBitcoinBlock(Base64.getDecoder().decode("AAAAILqkLkA0Wn+CajHTfbGl1ktntycyR3QiAAAAAAAAAAAAozrWvgY0ZHsmYzq4X6jeJYSAu7JeWcaOSLsLYIsSNisQkZtcbB8sF0nE0fA="))),
                Base64.getDecoder().decode("MEUCIQD03ORe3Ma/xKH0TvBOR+kKNI79Rx90Lxi4gqx3qNDongIgYXz3xKIiEZkWh7FxJsG7AHo7KiXFUPddZrhXqP2ddec="),
                Base64.getDecoder().decode("MFYwEAYHKoZIzj0CAQYFK4EEAAoDQgAEs8EEcMjo5Cbxk3dY2ftel6GJEXbLN9TBLUr0EHsao+iop1TAaiJ2DkTGBkL7qIOWfBl0DVIxM2Mm95YnUMjfmQ=="), null);

        byte[] serialized = SerializeDeserializeService.serialize(input);
        VeriBlockPoPTransaction deserialized =  SerializeDeserializeService.parseVeriBlockPoPTx(ByteBuffer.wrap(serialized));

        ValidationService.verify(deserialized);

        Assert.assertEquals(input, deserialized);
        Assert.assertEquals(Sha256Hash.wrap("2A014E88ED7AB65CDFAA85DAEAB07EEA6CBA5E147F736EDD8D02C2F9DDF0DEC6"), SerializeDeserializeService.getId(deserialized));
    }
}
